<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Core Values Assessment | Agora Consulting</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            margin: 0; 
            padding: 20px; 
            background: #f8fafc; 
            font-family: system-ui, -apple-system, sans-serif; 
        }
        .chat-message {
            margin-bottom: 16px;
        }
        .user-message {
            display: flex;
            justify-content: flex-end;
        }
        .ai-message {
            display: flex;
            justify-content: flex-start;
        }
        .message-content {
            max-width: 80%;
            padding: 16px;
            border-radius: 8px;
            word-wrap: break-word;
        }
        .user-content {
            background: #2563eb;
            color: white;
            margin-left: 60px;
        }
        .ai-content {
            background: #f3f4f6;
            color: #374151;
            margin-right: 60px;
        }
        .loading-dots {
            display: inline-flex;
            gap: 4px;
        }
        .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #9ca3af;
            animation: bounce 1.4s ease-in-out infinite both;
        }
        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div id="core-values-app" class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg overflow-hidden">
        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-6">
            <div class="flex items-center space-x-3">
                <div class="w-12 h-12 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                    <span class="text-2xl">ü§ñ</span>
                </div>
                <div>
                    <h1 class="text-2xl font-bold">Core Values Assessment</h1>
                    <p class="text-blue-100">Powered by Agora Consulting</p>
                </div>
            </div>
        </div>

        <!-- Connection Status -->
        <div id="connection-status" class="bg-amber-50 border-l-4 border-amber-400 p-4">
            <div class="flex">
                <span class="text-amber-400 mr-3 mt-0.5">‚ö†Ô∏è</span>
                <div class="text-sm text-amber-700">
                    <strong>Connecting:</strong> Establishing connection to assessment system...
                </div>
            </div>
        </div>

        <!-- Chat Messages -->
        <div id="chat-area" class="h-96 overflow-y-auto p-6">
            <!-- Messages will be added here -->
        </div>

        <!-- Input Area -->
        <div class="border-t p-4">
            <div class="flex space-x-4">
                <textarea 
                    id="user-input" 
                    placeholder="Share your thoughts..." 
                    class="flex-1 p-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    rows="2"
                    disabled
                ></textarea>
                <button 
                    id="send-button"
                    onclick="sendMessage()" 
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled
                >
                    Send
                </button>
            </div>
        </div>

        <!-- Email Results Section -->
        <div id="email-section" class="border-t bg-gray-50 p-6" style="display: none;">
            <h3 class="text-lg font-semibold mb-4">Email Your Results</h3>
            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Your Email (optional)
                        </label>
                        <input
                            type="email"
                            id="user-email"
                            placeholder="your-email@company.com"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Your Agora Advisor's Email (optional)
                        </label>
                        <input
                            type="email"
                            id="advisor-email"
                            placeholder="advisor@agoraconsulting.us"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <button
                        onclick="emailResults()"
                        class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        üìß Email Results
                    </button>
                    
                    <div id="email-status"></div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="bg-gray-50 px-6 py-3 text-sm text-gray-600">
            <div class="flex justify-between items-center">
                <span>Assessment Status</span>
                <span id="status" class="font-medium">Initializing...</span>
            </div>
            <div id="session-info" class="mt-1 text-xs text-gray-500"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://agora-core-values-tool-b42t71ej2.vercel.app';
        let sessionId = null;
        let isLoading = false;

        // Initialize the assessment
        async function startAssessment() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/start-assessment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                });
                
                if (!response.ok) throw new Error('Failed to start assessment');
                
                const data = await response.json();
                sessionId = data.sessionId;
                
                // Hide connection status
                document.getElementById('connection-status').style.display = 'none';
                
                // Add initial AI message
                addMessage(data.message.content, 'ai');
                
                // Enable input
                document.getElementById('user-input').disabled = false;
                document.getElementById('send-button').disabled = false;
                document.getElementById('status').textContent = 'In Progress';
                document.getElementById('session-info').textContent = `Session: ${sessionId}`;
                
            } catch (error) {
                console.error('Error starting assessment:', error);
                addMessage('I apologize, but I\'m having trouble connecting to our assessment system. Please try refreshing the page or contact support if the problem persists.', 'ai');
                document.getElementById('connection-status').innerHTML = `
                    <div class="flex">
                        <span class="text-red-400 mr-3 mt-0.5">‚ùå</span>
                        <div class="text-sm text-red-700">
                            <strong>Connection Failed:</strong> Unable to connect to assessment system.
                        </div>
                    </div>
                `;
            }
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const message = input.value.trim();
            
            if (!message || isLoading || !sessionId) return;
            
            // Add user message
            addMessage(message, 'user');
            input.value = '';
            
            // Show loading
            isLoading = true;
            document.getElementById('send-button').disabled = true;
            addLoadingMessage();
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/send-message`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId, message }),
                });
                
                if (!response.ok) throw new Error('Failed to send message');
                
                const data = await response.json();
                
                // Remove loading message
                removeLoadingMessage();
                
                // Add AI response
                addMessage(data.message.content, 'ai');
                
                // Check if assessment is complete
                if (data.message.content.includes('CORE VALUES ASSESSMENT')) {
                    document.getElementById('status').textContent = 'Assessment Complete';
                    document.getElementById('email-section').style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error sending message:', error);
                removeLoadingMessage();
                addMessage('I apologize, but I\'m having trouble processing your response right now. Could you please try again?', 'ai');
            }
            
            isLoading = false;
            document.getElementById('send-button').disabled = false;
        }

        function addMessage(content, type) {
            const chatArea = document.getElementById('chat-area');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}-message`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = `message-content ${type}-content`;
            contentDiv.innerHTML = `<strong>${type === 'user' ? 'üë§ You:' : 'ü§ñ AI Coach:'}</strong> ${content}`;
            
            messageDiv.appendChild(contentDiv);
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function addLoadingMessage() {
            const chatArea = document.getElementById('chat-area');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-message';
            loadingDiv.className = 'chat-message ai-message';
            loadingDiv.innerHTML = `
                <div class="message-content ai-content">
                    <strong>ü§ñ AI Coach:</strong> 
                    <div class="loading-dots">
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                    </div>
                </div>
            `;
            chatArea.appendChild(loadingDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function removeLoadingMessage() {
            const loadingMessage = document.getElementById('loading-message');
            if (loadingMessage) {
                loadingMessage.remove();
            }
        }

        async function emailResults() {
            const userEmail = document.getElementById('user-email').value;
            const advisorEmail = document.getElementById('advisor-email').value;
            
            if (!userEmail && !advisorEmail) {
                alert('Please enter at least one email address.');
                return;
            }
            
            const statusDiv = document.getElementById('email-status');
            statusDiv.innerHTML = '<span class="text-blue-600">üì§ Sending...</span>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/email-results`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId,
                        userEmail: userEmail || undefined,
                        advisorEmail: advisorEmail || undefined
                    }),
                });
                
                if (!response.ok) throw new Error('Failed to send email');
                
                statusDiv.innerHTML = '<span class="text-green-600">‚úÖ Results sent successfully!</span>';
                setTimeout(() => statusDiv.innerHTML = '', 3000);
                
            } catch (error) {
                console.error('Error sending email:', error);
                statusDiv.innerHTML = '<span class="text-red-600">‚ùå Failed to send. Please try again.</span>';
                setTimeout(() => statusDiv.innerHTML = '', 3000);
            }
        }

        // Allow Enter key to send message
        document.getElementById('user-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Start the assessment when page loads
        window.addEventListener('load', startAssessment);
    </script>
</body>
</html>
